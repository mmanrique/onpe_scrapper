<!DOCTYPE html>
<meta charset="utf-8">
<style>

    .background {
        fill: #eee;
        pointer-events: all;
    }
    .map-layer {
        fill: #fff;
        stroke: #aaa;
    }

</style>
<body>
<svg></svg>
<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script
        src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
<script>

    $(document).ready(function () {
        var width = 700,
            height = 1000,
            centered;

        var projection = d3.geo.mercator()
            .center([-71, -5])
//            .translate([width / 2, height / 2])
            .scale([2000]);

        var color = d3.scale.linear()
            .domain([1, 100])
            .range(['orange', '#FF69B4']);


        var path = d3.geo.path()
            .projection(projection);

        var svg = d3.select("svg")
            .attr("width", width)
            .attr("height", height);

        //add background
        svg.append('rect')
            .attr('class', 'background')
            .attr('width', width)
            .attr('height', height)
            .on('click', clicked);

        var g = svg.append('g');
        var mapLayer = g.append('g').classed('map-layer', true);

        function mouseover(d) {
            d3.select(this).style('fill', 'green');
        }

        function mouseout(context, d, i) {
            if(centered && d===centered){
                d3.select(context).style('#D5708B', color(i));
            }
            else{

                d3.select(context).style('fill', fillColor(d));
            }

        }

        function displayName(d) {
            console.log(d.properties.name_2)
        }

        function fillColor(d) {
            if (d.properties) {
                var fp = parseInt(d.properties.fp);
                var ppk = parseInt(d.properties.ppk);
                if (fp > ppk) {
                    return color(1);
                } else if (fp < ppk) {
                    return color(100)
                }
                else {
                    return color(70)
                }
            }
        }

        function clicked(d) {
            if(d.properties){
                console.log(d.properties.name);
                console.log(d.properties.departamento);
            }
            var x, y, k;

            // Compute centroid of the selected path
            if (d && centered !== d) {
                var centroid = path.centroid(d);
                x = centroid[0];
                y = centroid[1];
                k = 4;
                centered = d;
            } else {
                x = width / 2;
                y = height / 2;
                k = 1;
                centered = null;
            }

//             Highlight the clicked province
            mapLayer.selectAll('path')
                .style('fill', function(d){return centered && d===centered ? '#D5708B' : fillColor(d);});

            // Zoom
            g.transition()
                .duration(750)
                .attr('transform', 'translate(' + width / 2 + ',' + height / 2 + ')scale(' + k + ')translate(' + -x + ',' + -y + ')');
        }


        d3.json("../geojson/output/provincias_summary.json", function (error, json) {
            if(error) console.log(error);
            var features = json.features;
            console.log(features.length);
            mapLayer.selectAll("path")
                .data(features)
                .enter().append("path")
                .attr("d", path)
                .attr('vector-effect', 'non-scaling-stroke')
                .attr('fill', function(d){return fillColor(d)})
                .on("mouseover", mouseover)
                .on("mouseout", function (d, i) {
                    mouseout(this, d, i)
                })
                .on("click", clicked);
        });
    });

</script>
</body>